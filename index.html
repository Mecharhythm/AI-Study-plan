<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Study Planner â€” DeepSeek + Firebase</title>

<!-- Firebase (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<style>
:root{--accent:#4285f4;--bg:#f7f7f7;--card-radius:14px}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:#111}
header{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.12);height:56px}
header h1{font-size:16px;margin:0;font-weight:700}
header .right{display:flex;gap:8px;align-items:center}
.small-btn{border:none;background:#eee;padding:6px 8px;border-radius:8px;font-size:13px}
main{padding:12px 12px 120px}

/* tutorial */
.tutorialOverlay{position:fixed;inset:0;background:#fff;z-index:120;display:none;overflow:hidden}
.tutorialSlides{display:flex;flex-direction:row;width:500%;height:100%}
.tutorialSlide{flex:0 0 100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
.tutorialSlide p{font-size:18px;line-height:1.6;margin:0 0 18px}
.tutorialNav{position:absolute;bottom:28px;left:0;right:0;display:flex;justify-content:center;gap:12px}

/* cards */
.card-container{display:flex;gap:12px;overflow-x:auto;padding:12px 4px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
.day-card{flex:0 0 78%;min-width:78%;background:#fff;border-radius:var(--card-radius);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.12);scroll-snap-align:start;min-height:160px;transition:background .2s}
.day-card h3{margin:0 0 8px;font-size:16px}
.day-card p{margin:0;font-size:14px;line-height:1.5}

/* summary */
.summary-box{display:flex;gap:12px;align-items:flex-start;background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin:12px 0}
.summaryBar{width:6px;background:var(--accent);border-radius:3px}
.summaryContent{font-size:14px;color:#222;line-height:1.5}

/* chat */
.chat-box{position:fixed;left:12px;right:12px;bottom:12px;background:transparent;z-index:60}
.chatInner{background:#fff;border-radius:14px;padding:10px;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
.chatLog{max-height:180px;overflow:auto;padding:6px 4px;font-size:14px}
.msg{margin:6px 0;display:block}
.msg.user{text-align:right}
.msg.ai{text-align:left;color:var(--accent)}
.chatControls{display:flex;gap:8px;margin-top:8px}
input[type=text]{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:14px}
button.primary{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:700}
.smallNote{font-size:12px;color:#666;margin-top:8px}
.presetRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.presetBtn{padding:8px 10px;border-radius:8px;border:none;background:#f0f6ff;color:var(--accent);font-weight:600}
.utilRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{padding:6px 10px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06);font-size:13px}
.hidden{display:none}
.settingsModal{position:fixed;inset:80px 16px 80px 16px;background:#fff;border-radius:12px;z-index:130;padding:12px;box-shadow:0 8px 40px rgba(0,0,0,0.25);overflow:auto}
</style>
</head>
<body>

<header>
  <h1>AI Study Planner</h1>
  <div class="right">
    <div id="loginStatus" class="chip">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
    <button id="tutorialBtn" class="small-btn" title="ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¡¨ç¤º">ğŸ“</button>
    <button id="settingsBtn" class="small-btn" title="è¨­å®š">âš™ï¸</button>
    <button id="logoutBtn" class="small-btn hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<main>

  <!-- auth area -->
  <div id="authArea">
    <div style="padding:18px;background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,0.06);margin-bottom:12px">
      <h2 style="margin:0 0 8px">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
      <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
      <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="registerBtn" class="primary">æ–°è¦ç™»éŒ²</button>
        <button id="loginBtn" class="primary" style="background:#4caf50">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      <div id="authMessage" class="smallNote"></div>
    </div>
  </div>

  <!-- main UI (hidden until logged in) -->
  <div id="mainUI" class="hidden">
    <div class="toolbar" style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <div class="chip" id="userInfo">ã‚²ã‚¹ãƒˆ</div>
      <div class="chip" id="cardsCount">ã‚«ãƒ¼ãƒ‰: 0</div>
      <div class="chip" id="lastSaved">æœªä¿å­˜</div>
      <div class="chip" id="apiStatus">DeepSeek: æœªè¨­å®š</div>
    </div>

    <div class="card-container" id="cardContainer" aria-label="å­¦ç¿’è¨ˆç”»ã‚«ãƒ¼ãƒ‰"></div>

    <div class="summary-box">
      <div class="summaryBar"></div>
      <div class="summaryContent" id="summaryContent">è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ£ãƒƒãƒˆã§ã€Œäº¬å¤§å‘ã‘1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div>
      <div class="smallNote">è‰²ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é©ç”¨ï¼‰</div>
      <div class="presetRow" id="presetRow"></div>
    </div>

    <div class="utilRow" style="margin-top:10px">
      <button id="replanBtn" class="small-btn">ğŸ” å†è¨ˆç”»</button>
      <button id="saveBtn" class="small-btn">ğŸ’¾ ä¿å­˜</button>
      <button id="loadBtn" class="small-btn">ğŸ“‚ èª­è¾¼</button>
      <button id="resetBtn" class="small-btn">ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ</button>
      <div style="flex:1"></div>
      <div class="smallNote">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯å³ä¸Šã® ğŸ“ ã‹ã‚‰å†è¡¨ç¤ºã§ãã¾ã™</div>
    </div>
  </div>

</main>

<!-- chat floating -->
<div class="chat-box" role="dialog" aria-label="ãƒãƒ£ãƒƒãƒˆå…¥åŠ›">
  <div class="chatInner">
    <div class="chatLog" id="chatLog"></div>
    <div class="chatControls">
      <input type="text" id="chatInput" placeholder="ä¾‹ï¼šäº¬å¤§å‘ã‘ã®1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦">
      <button class="primary" id="sendBtn">é€ä¿¡</button>
    </div>
  </div>
</div>

<!-- tutorial overlay -->
<div class="tutorialOverlay" id="tutorialOverlay" role="dialog" aria-label="ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«">
  <div style="position:relative;height:100%">
    <div class="tutorialSlides" id="tutorialSlides">
      <div class="tutorialSlide"><p><strong>æ¨ªã«ã‚¹ãƒ¯ã‚¤ãƒ—</strong>ã—ã¦1æ—¥ã”ã¨ã®å­¦ç¿’è¨ˆç”»ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p><button onclick="tutorialNext()">æ¬¡ã¸</button></div>
      <div class="tutorialSlide"><p>1é€±é–“ã®å…¨ä½“åƒã¯è¦ç´„æ¬„ã§ä¸€ç›®ã§æŠŠæ¡ã§ãã¾ã™ï¼ˆå·¦ã®é’ãƒãƒ¼ãŒã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ã€‚</p><button onclick="tutorialNext()">æ¬¡ã¸</button></div>
      <div class="tutorialSlide"><p>ä¼šè©±ã§ <em>ã€Œäº¬å¤§å‘ã‘1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦ã€</em> ã¨å…¥åŠ›ã™ã‚‹ã¨AIãŒè¨ˆç”»ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p><button onclick="tutorialNext()">æ¬¡ã¸</button></div>
      <div class="tutorialSlide"><p>ä¼šè©±ã§ <em>ã€Œæ•°å­¦ã‚’è½ã¡ç€ã„ãŸé’ã«ã€</em> ã®ã‚ˆã†ã«æŒ‡ç¤ºã™ã‚‹ã¨è‰²ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</p><button onclick="tutorialNext()">æ¬¡ã¸</button></div>
      <div class="tutorialSlide"><p>ã€Œä»Šæ—¥ã§ããªã‹ã£ãŸåˆ†ã‚’å†è¨ˆç”»ã€ãªã©ã§AIãŒè² è·ã‚’å‡ç­‰åŒ–ã—ã¦å†ç”Ÿæˆã—ã¾ã™ã€‚</p><button onclick="closeTutorial()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button></div>
    </div>
  </div>
</div>

<!-- settings modal -->
<div id="settingsModal" class="settingsModal hidden">
  <h3 style="margin-top:0">è¨­å®š</h3>
  <label style="font-weight:700">DeepSeek API Key</label>
  <input id="deepseekKey" class="saveInput" placeholder="sk-..." />
  <label style="font-weight:700;margin-top:8px">DeepSeek Endpoint</label>
  <input id="deepseekEndpoint" class="saveInput" placeholder="https://api.deepseek.com/chat/completions" />
  <div style="margin-top:10px">
    <button id="saveSettings" class="primary">ä¿å­˜</button>
    <button id="closeSettings" class="small-btn">é–‰ã˜ã‚‹</button>
  </div>
  <div class="smallNote" style="margin-top:8px">â€» æœ¬ç•ªã§ã¯ã‚­ãƒ¼ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ç›´æ›¸ãã—ãªã„ã§ãã ã•ã„ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ä½¿ã†ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</div>
</div>

<script>
// ---------------- Firebase config (your provided values) ----------------
const firebaseConfig = {
  apiKey: "AIzaSyBqdk0zmXj0uFxg8jrxg5pqPw-1wfnv0AU",
  authDomain: "aistudyplan-4eddd.firebaseapp.com",
  projectId: "aistudyplan-4eddd",
  storageBucket: "aistudyplan-4eddd.firebasestorage.app",
  messagingSenderId: "819060793672",
  appId: "1:819060793672:web:3faff90a721b50da52137d",
  measurementId: "G-MFZ6PJBRJ0"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ---------------- App state ----------------
let appState = { plan: [], colors: {}, metadata: {}, user: null };
let DEEPSEEK_ENDPOINT = localStorage.getItem("deepseekEndpoint") || "https://api.deepseek.com/chat/completions";
let DEEPSEEK_KEY = localStorage.getItem("deepseekKey") || "";

// system prompt forcing JSON format (from our spec)
const SYSTEM_PROMPT = `ã‚ãªãŸã¯ã€ŒAI Study Plannerã€ã¨ã„ã†å­¦ç¿’è¨ˆç”»ç”Ÿæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚è¿”ç­”ã¯å¿…ãšJSONã®ã¿ã§ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§è¿”ã—ã¦ãã ã•ã„:
{
  "action":"createPlan | updatePlan | changeColors | chat | error",
  "message":"ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
  "plan":[{"day":"Day 1","tasks":{"æ•°å­¦":"...","è‹±èª":"..."}}...],
  "colors":{"æ•°å­¦":"#rrggbb"}
}
è‰²ã¯è‰²åãƒ»ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ»é›°å›²æ°—ãƒ¯ãƒ¼ãƒ‰ã‚’HEXã«å¤‰æ›ã—ã¦è¿”ã™ã“ã¨ã€‚æœªä½¿ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ç©ºé…åˆ—ã‹ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§è¿”ã™ã€‚`;

// ---------------- UI helpers ----------------
const el = id => document.getElementById(id);
function show(id){ el(id).classList.remove("hidden"); }
function hide(id){ el(id).classList.add("hidden"); }

// ---------------- Auth flows ----------------
el("registerBtn").addEventListener("click", async ()=>{
  const email = el("email").value.trim();
  const pw = el("password").value;
  if(!email || pw.length < 6) return el("authMessage").innerText = "ãƒ¡ãƒ¼ãƒ«ã¨6æ–‡å­—ä»¥ä¸Šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
  try{
    await auth.createUserWithEmailAndPassword(email, pw);
    el("authMessage").innerText = "ç™»éŒ²æˆåŠŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚";
  }catch(e){ el("authMessage").innerText = e.message; }
});

el("loginBtn").addEventListener("click", async ()=>{
  const email = el("email").value.trim();
  const pw = el("password").value;
  if(!email || pw.length < 6) return el("authMessage").innerText = "ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
  try{
    await auth.signInWithEmailAndPassword(email, pw);
    el("authMessage").innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚";
  }catch(e){ el("authMessage").innerText = e.message; }
});

el("logoutBtn").addEventListener("click", ()=> auth.signOut());

// on auth state changed
auth.onAuthStateChanged(async user => {
  appState.user = user ? { uid: user.uid, email: user.email } : null;
  el("loginStatus").textContent = user ? user.email : "æœªãƒ­ã‚°ã‚¤ãƒ³";
  el("logoutBtn").classList.toggle("hidden", !user);
  el("authArea").classList.toggle("hidden", !!user);
  el("mainUI").classList.toggle("hidden", !user);
  if(user){
    el("userInfo").textContent = user.email;
    // load user plan from firestore if exists
    try{
      const doc = await db.collection("users").doc(user.uid).get();
      if(doc.exists){
        const data = doc.data();
        appState.plan = data.plan || [];
        appState.colors = data.colors || {};
        appState.metadata = data.metadata || {};
        renderAppState();
        appendMsg("ai","ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
      } else {
        appState.plan = [];
        appState.colors = {};
        appState.metadata = {};
      }
    }catch(e){
      console.warn("firestore load err", e);
      appendMsg("ai","Firestoreã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã§å‹•ä½œã—ã¾ã™ã€‚");
    }
  } else {
    // logged out
    appState.plan = [];
    appState.colors = {};
    renderAppState();
  }
});

// ---------------- Render functions ----------------
function renderPlan(plan){
  const container = el("cardContainer");
  container.innerHTML = "";
  (plan || []).forEach(d=>{
    const div = document.createElement("div");
    div.className = "day-card";
    const subj = Object.keys(d.tasks || {})[0] || "";
    div.dataset.subject = subj;
    div.innerHTML = `<h3>${d.day}</h3><p>${Object.keys(d.tasks||{}).map(k=>`${k}ï¼š${d.tasks[k]}`).join("<br>")}</p>`;
    container.appendChild(div);
  });
  updateColors(appState.colors || {});
  el("cardsCount").textContent = "ã‚«ãƒ¼ãƒ‰: " + ((appState.plan||[]).length);
}

function updateSummary(plan){
  if(!plan || plan.length===0){ el("summaryContent").textContent = "è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ£ãƒƒãƒˆã§ã€Œäº¬å¤§å‘ã‘1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }
  const lines = plan.flatMap(p=>Object.keys(p.tasks||{}).map(k=>`${k}ï¼š${p.tasks[k]}`));
  const seen={}; const dedup=[];
  lines.forEach(l=>{ const subj=l.split("ï¼š")[0]; if(!seen[subj]){seen[subj]=1; dedup.push(l)}});
  el("summaryContent").textContent = dedup.join(" / ");
}

function updateColors(colors){
  appState.colors = Object.assign({}, appState.colors || {}, colors || {});
  document.querySelectorAll(".day-card").forEach(card=>{
    const subj = card.dataset.subject;
    if(subj && appState.colors[subj]) card.style.background = appState.colors[subj];
    else card.style.background = "#fff";
  });
}

function renderAppState(){
  renderPlan(appState.plan || []);
  updateSummary(appState.plan || []);
  el("lastSaved").textContent = appState.metadata.lastSaved ? new Date(appState.metadata.lastSaved).toLocaleString() : "æœªä¿å­˜";
  el("apiStatus").textContent = DEEPSEEK_KEY ? "DeepSeek: è¨­å®šæ¸ˆ" : "DeepSeek: æœªè¨­å®š";
}

// ---------------- Presets ----------------
const PRESETS = [
  {name:"è½ã¡ç€ã„ãŸé’", hex:"#6fa8dc"},
  {name:"æ˜ã‚‹ã„é’", hex:"#76baff"},
  {name:"è–„ã„é»„", hex:"#f9d342"},
  {name:"è½ã¡ç€ã„ãŸç·‘", hex:"#7bbf6a"},
  {name:"çŠç‘šã‚ªãƒ¬ãƒ³ã‚¸", hex:"#ff8a65"},
  {name:"è–„ç´«", hex:"#c28ff0"}
];

function renderPresets(){
  const row = el("presetRow"); row.innerHTML="";
  PRESETS.forEach(p=>{
    const btn = document.createElement("button"); btn.className="presetBtn"; btn.textContent=p.name;
    btn.onclick = ()=>{ const subj = prompt("è‰²ã‚’é©ç”¨ã™ã‚‹ç§‘ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šæ•°å­¦ï¼‰"); if(!subj) return; updateColors({[subj]:p.hex}); saveToFirestore(); renderAppState(); };
    row.appendChild(btn);
  });
}

// ---------------- DeepSeek call ----------------
async function callDeepSeek(userText){
  if(!DEEPSEEK_KEY){
    // demo fallback
    if(/è¨ˆç”»|1é€±é–“/.test(userText)){
      return {action:"createPlan", message:"ãƒ‡ãƒ¢ï¼š1é€±é–“è¨ˆç”»ã‚’ä½œæˆã—ã¾ã—ãŸ", plan:[
        {day:"Day 1", tasks:{"æ•°å­¦":"é’ãƒãƒ£ãƒ¼ãƒˆII ä¾‹é¡Œ15-20","è‹±èª":"ã‚·ã‚¹å˜100èª"}},
        {day:"Day 2", tasks:{"ç‰©ç†":"ã‚»ãƒŸãƒŠãƒ¼ åŠ›å­¦1ç« ","è‹±èª":"é•·æ–‡1é¡Œ"}},
        {day:"Day 3", tasks:{"æ•°å­¦":"éå»å•1é¡Œ","åŒ–å­¦":"é‡è¦å•é¡Œé›†1ç« "}}
      ], colors:{}};
    }
    if(/å†è¨ˆç”»|æœªå®Œäº†|ãƒªãƒ—ãƒ©ãƒ³/.test(userText)){
      return {action:"updatePlan", message:"ãƒ‡ãƒ¢ï¼šå†è¨ˆç”»ã—ã¾ã—ãŸ", plan:[
        {day:"Day 1", tasks:{"æ•°å­¦":"é’ãƒãƒ£ ä¾‹é¡Œ15-18ï¼ˆæ®‹ã‚Šï¼‰","è‹±èª":"ã‚·ã‚¹å˜80èª"}},
        {day:"Day 2", tasks:{"æ•°å­¦":"ä¾‹é¡Œ18-25","è‹±èª":"é•·æ–‡1é¡Œ"}}
      ], colors:{}};
    }
    if(/è‰²|é’|é»„è‰²|è½ã¡ç€/.test(userText)){
      return {action:"changeColors", message:"ãƒ‡ãƒ¢ï¼šè‰²ã‚’å¤‰æ›´ã—ã¾ã—ãŸ", plan:[], colors:{"æ•°å­¦":"#6fa8dc"}};
    }
    return {action:"chat", message:"ãƒ‡ãƒ¢å¿œç­”: å—ã‘å–ã‚Šã¾ã—ãŸ", plan:[], colors:{}};
  }

  const payload = {
    model: "deepseek-chat",
    messages: [
      {role:"system", content: SYSTEM_PROMPT},
      {role:"user", content: userText}
    ],
    max_tokens: 800,
    temperature: 0.2
  };

  try{
    const resp = await fetch(DEEPSEEK_ENDPOINT, {
      method:"POST",
      headers: {"Content-Type":"application/json","Authorization":"Bearer " + DEEPSEEK_KEY},
      body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const txt = await resp.text();
      console.error("DeepSeek error", resp.status, txt);
      return {action:"error", message:"DeepSeek API error: " + resp.status, plan:[], colors:{}};
    }
    const data = await resp.json();
    const content = data.choices?.[0]?.message?.content || data.output || "";
    try{
      return JSON.parse(content);
    }catch(e){
      console.error("parse fail", content);
      return {action:"error", message:"JSON parse error from DeepSeek", plan:[], colors:{}};
    }
  }catch(err){
    console.error(err);
    return {action:"error", message: "Network error: " + err.message, plan:[], colors:{}};
  }
}

// ---------------- Chat flow ----------------
el("sendBtn").addEventListener("click", onSend);
el("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") onSend(); });

async function onSend(){
  const text = el("chatInput").value.trim(); if(!text) return;
  appendMsg("user", text); el("chatInput").value="";
  appendMsg("ai", "ç”Ÿæˆä¸­â€¦");
  const res = await callDeepSeek(text);
  // remove last "ç”Ÿæˆä¸­â€¦"
  const log = el("chatLog");
  if(log.lastElementChild && log.lastElementChild.textContent.includes("ç”Ÿæˆä¸­")) log.removeChild(log.lastElementChild);

  if(res.message) appendMsg("ai", res.message);
  if(res.action === "createPlan" || res.action === "updatePlan"){
    if(res.plan && res.plan.length){
      appState.plan = res.plan;
      renderPlan(appState.plan);
      updateSummary(appState.plan);
    }
    if(res.colors) updateColors(res.colors);
    saveToFirestore();
  } else if(res.action === "changeColors"){
    if(res.colors) updateColors(res.colors);
    saveToFirestore();
  } else if(res.action === "chat"){
    // nothing
  } else if(res.action === "error"){
    appendMsg("ai", "ã‚¨ãƒ©ãƒ¼: " + (res.message || "ä¸æ˜"));
  }
}

function appendMsg(kind, text){
  const log = el("chatLog");
  const div = document.createElement("div");
  div.className = "msg " + (kind==="user"?"user":"ai");
  div.textContent = (kind==="user"?"ã‚ãªãŸï¼š":"AIï¼š") + text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// ---------------- Replan button ----------------
el("replanBtn").addEventListener("click", async ()=>{
  appendMsg("user", "å†è¨ˆç”»ã‚’ä¾é ¼ã—ã¾ã—ãŸ");
  appendMsg("ai", "ç”Ÿæˆä¸­â€¦");
  const prompt = "å†è¨ˆç”»: ç¾åœ¨ã®è¨ˆç”»ã®æœªå®Œäº†åˆ†ã‚’æŠ½å‡ºã—ã€ç¿Œæ—¥ä»¥é™ã«ç§»ã—ã¤ã¤è² è·ã‚’å‡ç­‰åŒ–ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®è¨ˆç”»: " + JSON.stringify(appState.plan || []);
  const res = await callDeepSeek(prompt);
  if(res.action === "updatePlan" && res.plan){
    appState.plan = res.plan;
    renderPlan(appState.plan);
    updateSummary(appState.plan);
    appendMsg("ai", res.message || "å†è¨ˆç”»ã—ã¾ã—ãŸ");
    if(res.colors) updateColors(res.colors);
    saveToFirestore();
  } else {
    appendMsg("ai", res.message || "å†è¨ˆç”»ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
});

// ---------------- Save / Load (Firestore per-user) ----------------
async function saveToFirestore(){
  if(!appState.user || !appState.user.uid){
    localSave();
    appendMsg("ai", "ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰");
    return;
  }
  try{
    const docRef = db.collection("users").doc(appState.user.uid);
    const payload = { plan: appState.plan, colors: appState.colors, metadata: { lastSaved: new Date().toISOString() } };
    await docRef.set(payload, {merge:true});
    appState.metadata.lastSaved = payload.metadata.lastSaved;
    el("lastSaved").textContent = new Date().toLocaleString();
    appendMsg("ai", "ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ");
  }catch(e){
    console.error("save error", e);
    appendMsg("ai", "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã™ï¼‰");
    localSave();
  }
}

function localSave(){
  const payload = { plan: appState.plan, colors: appState.colors, metadata: appState.metadata };
  localStorage.setItem("localPlan", JSON.stringify(payload));
  appState.metadata.lastSaved = new Date().toISOString();
  el("lastSaved").textContent = new Date().toLocaleString();
}

function loadLocal(){
  const raw = localStorage.getItem("localPlan");
  if(!raw) return false;
  try{
    const obj = JSON.parse(raw);
    appState.plan = obj.plan || [];
    appState.colors = obj.colors || {};
    appState.metadata = obj.metadata || {};
    renderAppState();
    appendMsg("ai", "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
    return true;
  }catch(e){ return false; }
}

el("loadBtn").addEventListener("click", async ()=>{
  if(appState.user && appState.user.uid){
    try{
      const doc = await db.collection("users").doc(appState.user.uid).get();
      if(doc.exists){
        const data = doc.data();
        appState.plan = data.plan || [];
        appState.colors = data.colors || {};
        appState.metadata = data.metadata || {};
        renderAppState();
        appendMsg("ai", "ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
        return;
      }
    }catch(e){ console.warn(e); }
  }
  loadLocal();
});

el("resetBtn").addEventListener("click", ()=>{
  if(!confirm("ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  appState = {plan:[], colors:{}, metadata:{}, user: appState.user};
  renderAppState();
  localStorage.removeItem("localPlan");
  if(appState.user && appState.user.uid){
    db.collection("users").doc(appState.user.uid).delete().catch(()=>{});
  }
  appendMsg("ai", "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
});

// ---------------- Settings modal ----------------
el("settingsBtn").addEventListener("click", ()=>{
  el("settingsModal").classList.toggle("hidden");
  el("deepseekKey").value = DEEPSEEK_KEY;
  el("deepseekEndpoint").value = DEEPSEEK_ENDPOINT;
});
el("closeSettings").addEventListener("click", ()=> el("settingsModal").classList.add("hidden"));
el("saveSettings").addEventListener("click", ()=>{
  DEEPSEEK_KEY = el("deepseekKey").value.trim();
  DEEPSEEK_ENDPOINT = el("deepseekEndpoint").value.trim() || DEEPSEEK_ENDPOINT;
  localStorage.setItem("deepseekKey", DEEPSEEK_KEY);
  localStorage.setItem("deepseekEndpoint", DEEPSEEK_ENDPOINT);
  el("settingsModal").classList.add("hidden");
  renderAppState();
  appendMsg("ai", "DeepSeekè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

// ---------------- Tutorial controls ----------------
let tutIndex = 0;
const tutSlides = document.querySelectorAll(".tutorialSlide");
function openTutorial(){ el("tutorialOverlay").style.display = "block"; tutIndex=0; showTut(); }
function tutorialNext(){ tutIndex++; if(tutIndex >= tutSlides.length) closeTutorial(); else showTut(); }
function showTut(){ const wrap = el("tutorialSlides"); wrap.style.transform = `translateX(-${tutIndex*100}%)`; tutSlides.forEach((s,i)=> s.style.display = i===tutIndex? "flex":"none"); }
function closeTutorial(){ el("tutorialOverlay").style.display = "none"; }
el("tutorialBtn").addEventListener("click", openTutorial);
if(!localStorage.getItem("tutorialSeen")){ openTutorial(); localStorage.setItem("tutorialSeen","1"); }

// ---------------- Init ----------------
function appendMsg(kind, text){ const log = el("chatLog"); const div = document.createElement("div"); div.className = "msg " + (kind==="user"?"user":"ai"); div.textContent = (kind==="user"?"ã‚ãªãŸï¼š":"AIï¼š") + text; log.appendChild(div); log.scrollTop = log.scrollHeight; }
el("sendBtn").addEventListener("click", ()=>{ const t = el("chatInput").value.trim(); if(t) { appendMsg("user", t); el("chatInput").value=""; onSend(); } });
el("chatInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") { const t = el("chatInput").value.trim(); if(t){ appendMsg("user", t); el("chatInput").value=""; onSend(); } } });

renderPresets();
renderAppState();
loadLocal();

</script>
</body>
</html>
