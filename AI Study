<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Study Planner â€” Full</title>
<style>
  :root{
    --accent:#4285f4;
    --bg:#f7f7f7;
    --card-radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#111}
  header{
    position:sticky;top:0;z-index:50;
    display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#fff;box-shadow:0 2px 6px #0002;height:56px;
  }
  header h1{font-size:16px;margin:0;font-weight:700}
  header .right{display:flex;gap:8px;align-items:center}
  .small-btn{border:none;background:#eee;padding:6px 8px;border-radius:8px;font-size:13px}
  main{padding:12px 12px 80px}

  /* tutorial overlay */
  .tutorialOverlay{position:fixed;inset:0;background:#fff;z-index:120;display:none;overflow:hidden}
  .tutorialSlides{display:flex;flex-direction:row;width:500%;height:100%}
  .tutorialSlide{flex:0 0 100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
  .tutorialSlide p{font-size:18px;line-height:1.6;margin:0 0 18px}
  .tutorialNav{position:absolute;bottom:28px;left:0;right:0;display:flex;justify-content:center;gap:12px}

  /* card container */
  .card-container{display:flex;gap:12px;overflow-x:auto;padding:12px 4px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
  .day-card{flex:0 0 78%;min-width:78%;background:#fff;border-radius:var(--card-radius);padding:14px;box-shadow:0 6px 18px #0002;scroll-snap-align:start;min-height:180px;transition:background .2s}
  .day-card h3{margin:0 0 8px;font-size:16px}
  .day-card p{margin:0;font-size:14px;line-height:1.5}

  /* summary box */
  .summary-box{display:flex;gap:12px;align-items:flex-start;background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 2px 8px #0001;margin:12px 0}
  .summaryBar{width:6px;background:var(--accent);border-radius:3px}
  .summaryContent{font-size:14px;color:#222;line-height:1.5}

  /* chat */
  .chat-box{position:fixed;left:12px;right:12px;bottom:12px;background:transparent;z-index:60}
  .chatInner{background:#fff;border-radius:14px;padding:10px;box-shadow:0 6px 20px #0002}
  .chatLog{max-height:160px;overflow:auto;padding:6px 4px;font-size:14px}
  .msg{margin:6px 0;display:block}
  .msg.user{text-align:right}
  .msg.ai{text-align:left;color:var(--accent)}
  .chatControls{display:flex;gap:8px;margin-top:8px}
  input[type=text]{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:14px}
  button.primary{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:700}

  /* toolbar under header for login info */
  .toolbar{display:flex;gap:8px;align-items:center;margin-top:8px}

  /* small util area */
  .utilRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{padding:6px 10px;background:#fff;border-radius:10px;box-shadow:0 2px 6px #0001;font-size:13px}

  /* responsive tweaks */
  @media (min-width:700px){
    .day-card{flex:0 0 45%;min-width:45%}
  }

  /* hidden helper */
  .hidden{display:none}
  a.link{color:var(--accent);text-decoration:none}
  .smallNote{font-size:12px;color:#666;margin-top:8px}
  .presetRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .presetBtn{padding:8px 10px;border-radius:8px;border:none;background:#f0f6ff;color:var(--accent);font-weight:600}
  .saveRow{display:flex;gap:8px;margin-top:10px;align-items:center}
  .saveInput{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
  .topRightText{font-size:13px;color:#333}
</style>
</head>
<body>

<header>
  <h1>AI Study Planner</h1>
  <div class="right">
    <div id="loginStatus" class="topRightText">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
    <button id="tutorialBtn" class="small-btn" title="ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¡¨ç¤º">ğŸ“</button>
    <button id="openSettings" class="small-btn" title="è¨­å®š">âš™ï¸</button>
  </div>
</header>

<main>

  <!-- top toolbar -->
  <div class="toolbar">
    <div id="userInfo" class="chip">ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</div>
    <div class="chip" id="cardsCount">ã‚«ãƒ¼ãƒ‰: 0</div>
    <div class="chip" id="lastSaved">æœªä¿å­˜</div>
    <div class="chip" id="apiStatus">DeepSeek: æœªè¨­å®š</div>
  </div>

  <!-- card container -->
  <div class="card-container" id="cardContainer" aria-label="å­¦ç¿’è¨ˆç”»ã‚«ãƒ¼ãƒ‰">
    <!-- cards injected by JS -->
  </div>

  <!-- summary -->
  <div class="summary-box" id="summaryBox">
    <div class="summaryBar"></div>
    <div class="summaryContent" id="summaryContent">è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ£ãƒƒãƒˆã§ã€Œäº¬å¤§å‘ã‘1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
  </div>

  <!-- presets -->
  <div>
    <div class="smallNote">è‰²ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é©ç”¨ï¼‰</div>
    <div class="presetRow" id="presetRow">
      <!-- preset buttons injected -->
    </div>
  </div>

  <!-- replan / export / import -->
  <div class="utilRow">
    <button id="replanBtn" class="small-btn">ğŸ” å†è¨ˆç”»</button>
    <button id="exportBtn" class="small-btn">â¬‡ ä¿å­˜ï¼ˆåœ§ç¸®ï¼‰</button>
    <button id="importBtn" class="small-btn">â¬† èª­è¾¼</button>
    <button id="clearBtn" class="small-btn">ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ</button>
    <div style="flex:1"></div>
    <div class="smallNote">â€» ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯å³ä¸Šã® ğŸ“ ã‹ã‚‰å†è¡¨ç¤ºã§ãã¾ã™</div>
  </div>

  <!-- settings modal simplified -->
  <div id="settingsModal" class="hidden" style="position:fixed;inset:80px 16px 80px 16px;background:#fff;border-radius:12px;z-index:130;padding:12px;box-shadow:0 8px 40px #0004;overflow:auto">
    <h3 style="margin-top:0">è¨­å®š</h3>
    <div style="margin-top:8px">
      <label style="font-weight:700">DeepSeek API Keyï¼ˆãƒ€ãƒŸãƒ¼ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯æœ¬ç•ªã‚­ãƒ¼ã«ç½®æ›ï¼‰</label>
      <input id="apiKeyInput" class="saveInput" placeholder="sk-xxxxxxxx..." />
    </div>
    <div style="margin-top:8px">
      <label style="font-weight:700">DeepSeek Endpoint</label>
      <input id="apiEndpointInput" class="saveInput" placeholder="https://api.deepseek.com/chat/completions" />
    </div>

    <hr>

    <div style="font-weight:700">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ—¢å®šã¯ãƒ­ãƒ¼ã‚«ãƒ«èªè¨¼ï¼‰</div>
    <div style="margin-top:8px">
      <label>èªè¨¼æ–¹å¼</label>
      <select id="authMode" class="saveInput">
        <option value="local">ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆãƒ‡ãƒ¢ï¼‰</option>
        <option value="firebase">Firebaseï¼ˆè¦è¨­å®šï¼‰</option>
      </select>
    </div>

    <div id="firebaseConfigArea" style="margin-top:8px;display:none">
      <div class="smallNote">Firebaseã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„</div>
      <textarea id="firebaseConfig" class="saveInput" rows=4 placeholder='{"apiKey":"...","authDomain":"...","projectId":"..."}'></textarea>
      <div class="smallNote">ã•ã‚‰ã«Firebase SDKã®èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–ã®æ‰‹é †ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼ˆä¸‹ã«èª¬æ˜ãŒã‚ã‚Šã¾ã™ï¼‰</div>
    </div>

    <hr>
    <div style="display:flex;gap:8px">
      <button id="saveSettings" class="primary">ä¿å­˜</button>
      <button id="closeSettings" class="small-btn">é–‰ã˜ã‚‹</button>
    </div>
    <div style="margin-top:8px;font-size:13px;color:#666">ä¿å­˜ã¯ LocalStorage ã«ä¿æŒã•ã‚Œã¾ã™ï¼ˆå¿…è¦ãªã‚‰åŒæœŸã‚’å®Ÿè£…ã—ã¾ã™ï¼‰</div>
  </div>

  <!-- import file element hidden -->
  <input type="file" id="importFile" accept=".txt,.json" class="hidden" />

</main>

<!-- chat floating -->
<div class="chat-box" role="dialog" aria-label="ãƒãƒ£ãƒƒãƒˆå…¥åŠ›">
  <div class="chatInner">
    <div class="chatLog" id="chatLog"></div>
    <div class="chatControls">
      <input type="text" id="chatInput" placeholder="ä¾‹ï¼šäº¬å¤§å‘ã‘ã®1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦">
      <button class="primary" id="sendBtn">é€ä¿¡</button>
    </div>
  </div>
</div>

<!-- tutorial overlay -->
<div class="tutorialOverlay" id="tutorialOverlay" role="dialog" aria-label="ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«">
  <div style="position:relative;height:100%">
    <div class="tutorialSlides" id="tutorialSlides">
      <div class="tutorialSlide">
        <p><strong>æ¨ªã«ã‚¹ãƒ¯ã‚¤ãƒ—</strong>ã—ã¦1æ—¥ã”ã¨ã®å­¦ç¿’è¨ˆç”»ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
        <button onclick="tutorialNext()">æ¬¡ã¸</button>
      </div>
      <div class="tutorialSlide">
        <p>1é€±é–“ã®å…¨ä½“åƒã¯è¦ç´„æ¬„ã§ä¸€ç›®ã§æŠŠæ¡ã§ãã¾ã™ï¼ˆå·¦ã®é’ãƒãƒ¼ãŒã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ã€‚</p>
        <button onclick="tutorialNext()">æ¬¡ã¸</button>
      </div>
      <div class="tutorialSlide">
        <p>ä¼šè©±ã§ <em>ã€Œäº¬å¤§å‘ã‘1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦ã€</em> ã¨å…¥åŠ›ã™ã‚‹ã¨AIãŒè¨ˆç”»ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
        <button onclick="tutorialNext()">æ¬¡ã¸</button>
      </div>
      <div class="tutorialSlide">
        <p>ä¼šè©±ã§ <em>ã€Œæ•°å­¦ã‚’è½ã¡ç€ã„ãŸé’ã«ã€</em> ã®ã‚ˆã†ã«æŒ‡ç¤ºã™ã‚‹ã¨è‰²ãŒå¤‰ã‚ã‚Šã¾ã™ï¼ˆè‰²åãƒ»HEXãƒ»é›°å›²æ°—ãƒ¯ãƒ¼ãƒ‰å¯¾å¿œï¼‰ã€‚</p>
        <button onclick="tutorialNext()">æ¬¡ã¸</button>
      </div>
      <div class="tutorialSlide">
        <p>ã€Œä»Šæ—¥ã§ããªã‹ã£ãŸåˆ†ã‚’å†è¨ˆç”»ã€ãªã©ã§AIãŒè² è·ã‚’å‡ç­‰åŒ–ã—ã¦å†ç”Ÿæˆã—ã¾ã™ã€‚</p>
        <button onclick="closeTutorial()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ----------------------
   åˆæœŸè¨­å®šã¨çŠ¶æ…‹
   ---------------------- */
const DEFAULT_API_ENDPOINT = "https://api.deepseek.com/chat/completions"; // ãƒ€ãƒŸãƒ¼
let API_ENDPOINT = localStorage.getItem("apiEndpoint") || DEFAULT_API_ENDPOINT;
let API_KEY = localStorage.getItem("apiKey") || "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // ãƒ€ãƒŸãƒ¼ï¼ˆå·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼‰
let AUTH_MODE = localStorage.getItem("authMode") || "local"; // local / firebase
let FIREBASE_CONFIG = (() => {
  try { return JSON.parse(localStorage.getItem("firebaseConfig") || "{}"); } catch { return {}; }
})();

document.getElementById("apiKeyInput").value = API_KEY;
document.getElementById("apiEndpointInput").value = API_ENDPOINT;
document.getElementById("authMode").value = AUTH_MODE;
document.getElementById("firebaseConfig").value = JSON.stringify(FIREBASE_CONFIG);

/* ----------------------
   ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆä¿å­˜å½¢å¼ï¼‰
   - plan: [{day:"Day 1", tasks:{ç§‘ç›®:ã‚¿ã‚¹ã‚¯}} ...]
   - colors: {ç§‘ç›®:"#rrggbb"}
   - metadata: {user, lastSaved}
   ä¿å­˜ã¯ localStorage ã‚’åŸºæœ¬ã¨ã—ã€ã€Œåœ§ç¸®ä¿å­˜ã€ã§ã¯ base64(JSON) ã‚’æä¾›
   ---------------------- */
let appState = {
  user: { id: null, email: null, type: "guest" },
  plan: [],
  colors: {},
  metadata: {}
};

// load from localstorage if exists
function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem("appState") || "null");
    if (s) {
      appState = s;
      renderAppState();
      setLoginDisplay();
    }
  } catch(e) { console.warn("loadState failed", e) }
}
function saveState() {
  appState.metadata.lastSaved = new Date().toISOString();
  localStorage.setItem("appState", JSON.stringify(appState));
  document.getElementById("lastSaved").textContent = new Date().toLocaleString();
}

/* ----------------------
   UI rendering
   ---------------------- */
function renderAppState() {
  renderPlan(appState.plan || []);
  updateSummary(appState.plan || []);
  updateColors(appState.colors || {});
  document.getElementById("cardsCount").textContent = "ã‚«ãƒ¼ãƒ‰: " + (appState.plan? appState.plan.length:0);
  document.getElementById("apiStatus").textContent = API_KEY && API_KEY !== "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx" ? "DeepSeek: è¨­å®šæ¸ˆ" : "DeepSeek: æœªè¨­å®š";
  if (appState.metadata.lastSaved) document.getElementById("lastSaved").textContent = new Date(appState.metadata.lastSaved).toLocaleString();
}

/* renderPlan */
function renderPlan(plan) {
  const container = document.getElementById("cardContainer");
  container.innerHTML = "";
  plan.forEach((d, idx) => {
    const div = document.createElement("div");
    div.className = "day-card";
    // subject heuristic: pick most frequent subject or first key
    const subjects = Object.keys(d.tasks || {});
    div.dataset.subject = subjects[0] || "";
    div.innerHTML = `<h3>${d.day}</h3><p>${Object.keys(d.tasks || {}).map(k=>`${k}: ${d.tasks[k]}`).join("<br>")}</p>`;
    container.appendChild(div);
  });
  // apply colors after DOM created
  updateColors(appState.colors || {});
}

/* update summary */
function updateSummary(plan) {
  if(!plan || plan.length===0){
    document.getElementById("summaryContent").textContent = "è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ£ãƒƒãƒˆã§ã€Œäº¬å¤§å‘ã‘1é€±é–“è¨ˆç”»ã‚’ä½œã£ã¦ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  const lines = plan.flatMap(p => Object.keys(p.tasks||{}).map(k => `${k}ï¼š${p.tasks[k]}`));
  // reduce / dedupe by subject keep first occurrence
  const seen = {};
  const dedup = [];
  lines.forEach(l=>{
    const subj = l.split("ï¼š")[0];
    if(!seen[subj]){seen[subj]=true; dedup.push(l)}
  });
  document.getElementById("summaryContent").textContent = dedup.join(" / ");
}

/* update colors */
function updateColors(colors) {
  appState.colors = {...appState.colors, ...colors};
  document.querySelectorAll(".day-card").forEach(card=>{
    const subj = card.dataset.subject;
    if(subj && appState.colors[subj]) card.style.background = appState.colors[subj];
    else card.style.background = "#fff";
  });
}

/* ----------------------
   Preset colors
   ---------------------- */
const PRESETS = [
  {name:"è½ã¡ç€ã„ãŸé’", hex:"#6fa8dc"},
  {name:"æ˜ã‚‹ã„é’", hex:"#76baff"},
  {name:"è–„ã„é»„", hex:"#f9d342"},
  {name:"è½ã¡ç€ã„ãŸç·‘", hex:"#7bbf6a"},
  {name:"çŠç‘šã‚ªãƒ¬ãƒ³ã‚¸", hex:"#ff8a65"},
  {name:"è–„ç´«", hex:"#c28ff0"}
];

function renderPresets() {
  const row = document.getElementById("presetRow");
  row.innerHTML = "";
  PRESETS.forEach(p=>{
    const btn = document.createElement("button");
    btn.className = "presetBtn";
    btn.textContent = p.name;
    btn.onclick = ()=> {
      // apply to currently focused subject or show prompt
      const subj = prompt("è‰²ã‚’é©ç”¨ã™ã‚‹ç§‘ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šæ•°å­¦ï¼‰");
      if(!subj) return;
      const colors = {}; colors[subj] = p.hex;
      updateColors(colors);
      saveState();
    };
    row.appendChild(btn);
  });
}

/* ----------------------
   Chat + DeepSeek integration
   - callDeepSeek(text) sends to API_ENDPOINT with API_KEY
   - expects JSON response string (per system prompt)
   ---------------------- */
async function callDeepSeek(userText){
  // If API_KEY is default dummy, return a demo response to allow offline testing
  if(!API_KEY || API_KEY === "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx"){
    // Demo heuristic: simple commands
    if(/è¨ˆç”»/i.test(userText) || /1é€±é–“/i.test(userText)){
      return {
        action:"createPlan",
        message:"ãƒ‡ãƒ¢ï¼š1é€±é–“è¨ˆç”»ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆãƒ€ãƒŸãƒ¼ï¼‰",
        plan:[
          {day:"Day 1", tasks:{"æ•°å­¦":"é’ãƒãƒ£ãƒ¼ãƒˆII ä¾‹é¡Œ15-20","è‹±èª":"ã‚·ã‚¹å˜100èª"}},
          {day:"Day 2", tasks:{"ç‰©ç†":"ã‚»ãƒŸãƒŠãƒ¼ åŠ›å­¦1ç« ","è‹±èª":"é•·æ–‡1é¡Œ"}},
          {day:"Day 3", tasks:{"æ•°å­¦":"éå»å•1é¡Œ","åŒ–å­¦":"é‡è¦å•é¡Œé›†1ç« "}}
        ],
        colors: {}
      };
    }
    if(/å†è¨ˆç”»|ä»Šæ—¥ã§ããªã‹ã£ãŸ|ãƒªãƒ—ãƒ©ãƒ³/i.test(userText)){
      return {
        action:"updatePlan",
        message:"ãƒ‡ãƒ¢ï¼šå†è¨ˆç”»ã‚’è¡Œã„ã¾ã—ãŸï¼ˆãƒ€ãƒŸãƒ¼ï¼‰",
        plan:[
          {day:"Day 1", tasks:{"æ•°å­¦":"é’ãƒãƒ£ ä¾‹é¡Œ15-18ï¼ˆæ®‹ã‚Šï¼‰","è‹±èª":"ã‚·ã‚¹å˜80èª"}},
          {day:"Day 2", tasks:{"æ•°å­¦":"ä¾‹é¡Œ18-25","è‹±èª":"é•·æ–‡1é¡Œ"}}
        ],
        colors: {}
      };
    }
    if(/è‰²|é’|é»„è‰²|è‰²å¤‰æ›´|è½ã¡ç€ã„ãŸ/i.test(userText)){
      // pick math as subject demo
      return {action:"changeColors", message:"ãƒ‡ãƒ¢ï¼šè‰²ã‚’å¤‰æ›´ã—ã¾ã—ãŸ", plan:[], colors:{"æ•°å­¦":"#6fa8dc"}};
    }
    // fallback
    return {action:"chat", message:"ï¼ˆãƒ‡ãƒ¢å¿œç­”ï¼‰å—ã‘å–ã‚Šã¾ã—ãŸã€‚", plan:[], colors:{}};
  }

  // real API call
  const payload = {
    model: "deepseek-chat",
    messages: [{role:"system", content: "ã‚ãªãŸã¯å­¦ç¿’è¨ˆç”»ç”Ÿæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å¿…ãšJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼ˆæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰"} , {role:"user", content: userText}],
    max_tokens:800
  };

  try {
    const resp = await fetch(API_ENDPOINT, {
      method:"POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": "Bearer " + API_KEY
      },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    // assumption: API returns content as JSON string in choices[0].message.content
    const content = data.choices?.[0]?.message?.content || data.result || "";
    try {
      return JSON.parse(content);
    } catch(e){
      console.error("Failed to parse response as JSON", content, e);
      return {action:"error", message:"APIã®è¿”ç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ", plan:[], colors:{}};
    }
  } catch(err){
    console.error(err);
    return {action:"error", message:"APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message, plan:[], colors:{}};
  }
}

/* ----------------------
   Chat send handling
   ---------------------- */
document.getElementById("sendBtn").addEventListener("click", onSend);
document.getElementById("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") onSend(); });

async function onSend(){
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if(!text) return;
  appendMessage("user", text);
  input.value = "";
  // show loading
  appendMessage("ai", "ç”Ÿæˆä¸­â€¦");
  const res = await callDeepSeek(text);
  // remove last "ç”Ÿæˆä¸­â€¦" message
  const log = document.getElementById("chatLog");
  const nodes = log.children;
  if(nodes.length && nodes[nodes.length-1].textContent === "ç”Ÿæˆä¸­â€¦") log.removeChild(nodes[nodes.length-1]);

  if(res.message) appendMessage("ai", res.message);
  if(res.action === "createPlan" || res.action === "updatePlan"){
    if(res.plan && res.plan.length){
      appState.plan = res.plan;
      renderPlan(appState.plan);
      updateSummary(appState.plan);
    }
    if(res.colors) updateColors(res.colors);
  } else if(res.action === "changeColors"){
    if(res.colors) updateColors(res.colors);
  } else if(res.action === "chat"){
    // nothing else
  } else if(res.action === "error"){
    appendMessage("ai", "ã‚¨ãƒ©ãƒ¼: " + (res.message || "ä¸æ˜"));
  }
  saveState();
}

/* helper to append messages */
function appendMessage(kind, text){
  const log = document.getElementById("chatLog");
  const div = document.createElement("div");
  div.className = "msg " + (kind==="user"? "user":"ai");
  div.textContent = (kind==="user"? "ã‚ãªãŸï¼š":"AIï¼š") + text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* ----------------------
   Replan button
   ---------------------- */
document.getElementById("replanBtn").addEventListener("click", async ()=>{
  // For demo: we send a replan instruction to the AI including current plan and "æœªå®Œäº†" hint.
  const prompt = "å†è¨ˆç”»ï¼šç¾åœ¨ã®è¨ˆç”»ã®æœªå®Œäº†åˆ†ã‚’ç¿Œæ—¥ã«ç§»å‹•ã—ã€è² è·ã‚’å‡ç­‰åŒ–ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®è¨ˆç”»ï¼š" + JSON.stringify(appState.plan || []);
  appendMessage("user", "å†è¨ˆç”»ã‚’ä¾é ¼ã—ã¾ã—ãŸ");
  appendMessage("ai", "ç”Ÿæˆä¸­â€¦");
  const res = await callDeepSeek(prompt);
  // remove "ç”Ÿæˆä¸­â€¦"
  const log = document.getElementById("chatLog");
  const nodes = log.children;
  if(nodes.length && nodes[nodes.length-1].textContent === "ç”Ÿæˆä¸­â€¦") log.removeChild(nodes[nodes.length-1]);

  if(res.action === "updatePlan" && res.plan){
    appState.plan = res.plan;
    renderPlan(appState.plan);
    updateSummary(appState.plan);
    appendMessage("ai", res.message || "å†è¨ˆç”»ã—ã¾ã—ãŸ");
  } else {
    appendMessage("ai", res.message || "å†è¨ˆç”»ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ");
  }
  if(res.colors) updateColors(res.colors);
  saveState();
});

/* ----------------------
   Export (compressed) & Import
   - compressed format = base64(JSON)
   ---------------------- */
function exportCompressed(){
  const payload = {plan: appState.plan, colors: appState.colors, metadata: appState.metadata, user: appState.user};
  const json = JSON.stringify(payload);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  // create download link
  const blob = new Blob([b64], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "study-plan.b64.txt";
  a.click();
  URL.revokeObjectURL(url);
  appendMessage("ai", "åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
}

document.getElementById("exportBtn").addEventListener("click", exportCompressed);

/* import file */
document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const text = ev.target.result.trim();
      // if it's base64, decode
      let decoded;
      try{ decoded = decodeURIComponent(escape(atob(text))); }
      catch{ decoded = text; }
      const obj = JSON.parse(decoded);
      appState.plan = obj.plan || [];
      appState.colors = obj.colors || {};
      appState.metadata = obj.metadata || {};
      appState.user = obj.user || appState.user;
      renderAppState();
      saveState();
      appendMessage("ai", "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
    }catch(err){
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    }
  };
  reader.readAsText(f);
});

/* reset */
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if(!confirm("ãƒ­ãƒ¼ã‚«ãƒ«ã®è¨ˆç”»ã¨è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  appState = {user:{id:null,email:null,type:"guest"},plan:[],colors:{},metadata:{}};
  localStorage.removeItem("appState");
  renderAppState();
  setLoginDisplay();
});

/* ----------------------
   Settings modal
   ---------------------- */
document.getElementById("openSettings").addEventListener("click", ()=>{
  document.getElementById("settingsModal").classList.remove("hidden");
  document.getElementById("apiKeyInput").value = API_KEY;
  document.getElementById("apiEndpointInput").value = API_ENDPOINT;
  document.getElementById("authMode").value = AUTH_MODE;
  document.getElementById("firebaseConfig").value = JSON.stringify(FIREBASE_CONFIG);
  document.getElementById("firebaseConfigArea").style.display = AUTH_MODE==="firebase" ? "block":"none";
});
document.getElementById("closeSettings").addEventListener("click", ()=> document.getElementById("settingsModal").classList.add("hidden"));
document.getElementById("authMode").addEventListener("change",(e)=>{
  document.getElementById("firebaseConfigArea").style.display = e.target.value==="firebase"?"block":"none";
});

document.getElementById("saveSettings").addEventListener("click", ()=>{
  API_KEY = document.getElementById("apiKeyInput").value.trim();
  API_ENDPOINT = document.getElementById("apiEndpointInput").value.trim() || DEFAULT_API_ENDPOINT;
  AUTH_MODE = document.getElementById("authMode").value;
  try{ FIREBASE_CONFIG = JSON.parse(document.getElementById("firebaseConfig").value || "{}"); }catch(e){ alert("Firebase config ãŒä¸æ­£ã§ã™"); return; }
  localStorage.setItem("apiKey", API_KEY);
  localStorage.setItem("apiEndpoint", API_ENDPOINT);
  localStorage.setItem("authMode", AUTH_MODE);
  localStorage.setItem("firebaseConfig", JSON.stringify(FIREBASE_CONFIG));
  document.getElementById("settingsModal").classList.add("hidden");
  renderAppState();
  alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚Firebaseã‚’ä½¿ã†å ´åˆã¯è¿½åŠ æ‰‹é †ã‚’è¡Œã£ã¦ãã ã•ã„ï¼ˆä¸‹è¨˜å‚ç…§ï¼‰");
});

/* ----------------------
   Login (local demo) & Firebase hint
   For simplicity we implement a local email login demo.
   To enable Firebase:
   - set authMode to 'firebase' in settings
   - provide FIREBASE_CONFIG (object) and load Firebase SDK per instructions below
   ---------------------- */
function localSignIn(email){
  appState.user = {id:"local-"+btoa(email).slice(0,8), email: email, type: "local"};
  saveState();
  setLoginDisplay();
}
function localSignOut(){
  appState.user = {id:null,email:null,type:"guest"};
  saveState();
  setLoginDisplay();
}

function setLoginDisplay(){
  const s = document.getElementById("loginStatus");
  if(appState.user && appState.user.email){
    s.textContent = appState.user.email;
    document.getElementById("userInfo").textContent = appState.user.email;
  }else{
    s.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    document.getElementById("userInfo").textContent = "ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰";
  }
}

/* quick login via clicking userInfo */
document.getElementById("userInfo").addEventListener("click", ()=>{
  if(AUTH_MODE==="firebase"){
    alert("Firebaseèªè¨¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯è¨­å®šã§ Firebase config ã‚’å…¥åŠ›ã—ã€SDK ã®èª­ã¿è¾¼ã¿æ‰‹é †ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚\nâ€» ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã«ã¯ãƒ­ãƒ¼ã‚«ãƒ«èªè¨¼ã®ã¿çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™");
    return;
  }
  const email = prompt("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰");
  if(!email) return;
  localSignIn(email);
});

/* ----------------------
   Tutorial controls
   ---------------------- */
let tutIndex = 0;
const tutSlides = document.querySelectorAll(".tutorialSlide");
function openTutorial(){
  document.getElementById("tutorialOverlay").style.display = "block";
  tutIndex = 0; showTut();
}
function tutorialNext(){
  tutIndex++;
  if(tutIndex >= tutSlides.length) closeTutorial();
  else showTut();
}
function showTut(){
  const wrap = document.getElementById("tutorialSlides");
  wrap.style.transform = `translateX(-${tutIndex * 100}%)`;
  tutSlides.forEach((s,i)=> s.style.display = (i===tutIndex? "flex":"none"));
}
function closeTutorial(){
  document.getElementById("tutorialOverlay").style.display = "none";
}
document.getElementById("tutorialBtn").addEventListener("click", openTutorial);

/* initial tutorial on first visit */
if(!localStorage.getItem("tutorialSeen")){
  openTutorial();
  localStorage.setItem("tutorialSeen", "1");
}

/* ----------------------
   init
   ---------------------- */
renderPresets();
loadState();
renderAppState();
setLoginDisplay();

/* ----------------------
   Helpful notes for operators (not executed):
   - To enable Firebase Auth:
     1) Create Firebase project, enable Email/Password provider (and Google/Apple if desired).
     2) Put firebaseConfig JSON into settings (apiKey, authDomain, projectId, etc).
     3) Load Firebase SDKs in this page (e.g. via <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script> and firebase-auth-compat.js)
     4) Initialize firebase and replace localSignIn/localSignOut with firebase auth flows.
   - To use a secure API key in production: do NOT embed your key in client JS.
     Use a server proxy or serverless function to hold the key and forward requests.
   ---------------------- */

</script>

</body>
</html>
